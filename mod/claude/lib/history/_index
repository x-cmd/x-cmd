# shellcheck shell=dash

xrc:mod:lib     claude      history/ls  history/rm  history/util

___x_cmd_claude_history(){
    [ "$#" -gt 0 ] ||   set -- ls

    local op="$1";      shift
    case "$op" in
        preview|ls|rm)      ___x_cmd_claude_history_"$op"   "$@" ;;
        -h|--help)          ___x_cmd help -m claude history "$@" ;       return 0 ;;
        *)                  N=claude M="history not such [subcmd=$op]" log:ret:64 ;;
    esac
}

___x_cmd_claude_history_preview(){

    case "$1" in
        -h|--help)     ___x_cmd help -m claude history preview ;       return 0 ;;
    esac

    local session_id="$1"
    local session_file="$(___x_cmd_cmds find "$___X_CMD_CLAUDE_CODE_DATA_PATH" -name "${session_id}.jsonl")"
    [ -n "$session_file" ] || N=claude M="Cannot find the history conversation file -> $session_id" log:ret:64

    ___x_cmd_claude_history_preview___raw "$session_file" \
        | LC_ALL=C ___x_cmd awk \
            -v COLUMNS="$COLUMNS" \
            -f "$___X_CMD_ROOT_MOD/claude/lib/awk/history_preview.awk"
}

___x_cmd_claude_history_preview___raw(){
    local session_file="$1"
    ___x_cmd jq -s '
        map(
            select(.type == "user" or .type == "assistant") |
            {
            timestamp: .timestamp,
            role: .message.role,
            model: .message.model,
            content: (
                if (.message.content | type) == "string" then
                .message.content
                else
                (.message.content | map(select(.type == "text" or .type == "thinking" or .type == "tool_use" or .type == "tool_result")))
                end
            )
            }
        )
    ' "$session_file"
}


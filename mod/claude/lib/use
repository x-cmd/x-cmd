# shellcheck shell=dash

___x_cmd_claude_use(){
    local op="$1"
    case "$op" in
        -h|--help)      ___x_cmd help -m claude use; return 0 ;;
        "")             ___x_cmd help -m claude use; return 64 ;;
        kimi|deepseek|ds)
                        shift; ___x_cmd_claude_use___runcmd "$op" "$@" ;;
        *)              N=claude M="Unknown subcmd -> $op" log:ret:64 ;;
    esac
}

___x_cmd_claude_use___runcmd(){
    local provider="$1"; shift

    local url="$ANTHROPIC_BASE_URL"
    local token="$ANTHROPIC_AUTH_TOKEN"
    local timeout="${API_TIMEOUT_MS:-"60000"}"
    local model="$ANTHROPIC_MODEL"
    local fast_model="$ANTHROPIC_SMALL_FAST_MODEL"
    local nonessential_traffic="$CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC"

    case "$provider" in
        deepseek|ds)
            url="${url:-"https://api.deepseek.com/anthropic"}"
            token="${DEEPSEEK_API_KEY:-"$(___x_cmd deepseek --cur get apikey 2>/dev/null)"}"
            model="${model:-"deepseek-chat"}"
            fast_model="${fast_model:-"deepseek-chat"}"
            nonessential_traffic="${nonessential_traffic:-"1"}"
            ;;
        kimi)
            url="${url:-"https://api.moonshot.cn/anthropic"}"
            token="${MOONSHOT_API_KEY:-"$(___x_cmd moonshot --cur get apikey 2>/dev/null)"}"
            model="${model:-"kimi-k2-turbo-preview"}"
            fast_model="${fast_model:-"kimi-k2-turbo-preview"}"
            ;;
        *)  claude:error "Unknown provider -> $provider"
            return 1
            ;;
    esac
    claude:debug --url "$url" --token "$token" --timeout "$timeout" --model "$model" --fast_model "$fast_model" --nonessential_traffic "$nonessential_traffic" "Use provider[$provider] to run claude-code"

    ANTHROPIC_BASE_URL="${url}"                                        \
    ANTHROPIC_AUTH_TOKEN="${token}"                                    \
    API_TIMEOUT_MS="${timeout}"                                        \
    ANTHROPIC_MODEL="${model}"                                         \
    ANTHROPIC_SMALL_FAST_MODEL="${fast_model}"                         \
    CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC="${nonessential_traffic}" \
        ___x_cmd_claude___runcmd "$@"
}

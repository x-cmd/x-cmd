# shellcheck shell=dash

___x_cmd_font_nerd_install(){
    local style=auto
    while [ $# -gt 0 ]; do
        case "$1" in
            --auto|--gh|--cb)   style="${1#--}"; shift ;;
            -h|--help)          ___x_cmd help -m font nerd install; break ;;
            *)                  break ;;
        esac
    done
    ___x_cmd_font_nerd_install___"$style" "$@"
}

___x_cmd_font_nerd_install___auto(){
    if ___x_cmd websrc is cn; then
        ___x_cmd_font_nerd_install___cb     "$@"
    else
        ___x_cmd_font_nerd_install___gh     "$@"
    fi
}

___x_cmd_font_nerd_install___gh(){
    local name="${1:?'Provide font name, e.g: FiraCode'}"
    ___x_cmd_font_nerd_install___handler "$name" \
        "https://github.com/ryanoasis/nerd-fonts/releases/download/${___X_CMD_FONT_NERD_VERSION}/${name}.tar.xz"
}

___x_cmd_font_nerd_install___cb(){
    local name="${1:?'Provide font name, e.g: FiraCode'}"
    ___x_cmd_font_nerd_install___handler "$name" \
        "https://codeberg.org/x-cmd-sourcecode/nerd-fonts/releases/download/${___X_CMD_FONT_NERD_VERSION}/${name}.tar.xz"
}

___x_cmd_font_nerd_install___handler(){
    local name="${1:?'Provide font name, e.g: FiraCode'}"
    local source="${2:?'Provide font resource link'}"
    local target="${___X_CMD_FONT_CACHE}/${___X_CMD_FONT_NERD_VERSION}/${name}.tar.xz"

    font:info --source "$source" --target "$target" "Download ${name} resource file..."
    ___x_cmd mkdirp  "${___X_CMD_FONT_CACHE}/${___X_CMD_FONT_NERD_VERSION}" || return
    ___x_cmd curl -L "$source" -o "$target" || return

    # unzip
    local tmp="${___X_CMD_FONT_TMP}/${___X_CMD_FONT_NERD_VERSION}/${name}"
    ___X_CMD_ZUZ_QUIET=1 ___x_cmd uz "$target" "$tmp" || {
        font:error "Fail to extract $target"
        return 1
    }
    # cp and refresh
    ___x_cmd_font_install___install_system "$tmp" || return
    ___x_cmd_font_refresh || return

    ___x_cmd ui tf true "${name} Font Installation Successful, Tips:" \
        "Set up terminal font: https://x-cmd.com/mod/font/cookbook-2"
}
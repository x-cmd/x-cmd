# shellcheck shell=dash disable=2016

___x_cmd_codex_skill(){
    [ "$#" -gt 0 ] ||   set -- ls

    local op="$1";      shift
    case "$op" in
        ll|ls|add|rm|setup)
                        ___x_cmd_codex_skill_"$op"   "$@" ;;
        -h|--help)      ___x_cmd help -m codex skill "$@" ;       return 0 ;;
        *)              N=codex M="skill not such [subcmd=$op]" log:ret:64 ;;
    esac
}

___x_cmd_codex_skill_ll(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill ll' help:arg:parse
    ___x_cmd skill ll
}

___x_cmd_codex_skill_ls(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill ls' help:arg:parse
    ___x_cmd skill active ls
}

___x_cmd_codex_skill_rm(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill rm' help:arg:parse
    ___x_cmd skill active rm "$@"
}

___x_cmd_codex_skill_add(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill add' help:arg:parse
    ___x_cmd skill active add "$@"
}


___x_cmd_codex_skill_setup(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill setup' help:arg:parse

    local x_=""; ___x_cmd_codex_skill_setup___get_agentfile_ || return $?
    local fp="$x_"
    codex:info "Setting up x-cmd skills to Codex -> $fp"
    ___x_cmd ensurefp "$fp"         || return $?
    ___x_cmd skill prompt >> "$fp"  || return $?

    codex:info "Setup complete"
}

___x_cmd_codex_skill_setup___get_agentfile_(){
    local dir="${CODEX_HOME:-$HOME}/.codex"
    local fp="$dir/AGENTS.override.md"
    [ -f "$fp" ] || fp="$dir/AGENTS.md"
    [ -f "$fp" ] || {
        local filename; filename="$(
        < "$dir/config.toml" ___x_cmd_cmds awk '
(match($0, "^project_doc_fallback_filenames[ \t]+=[ \t]+\\[[ \t]*\"")){
    l = substr($0, RSTART+RLENGTH)
    print substr(l, 1, index(l, "\"")-1)
}
'
        )"
        [ -z "$filename" ] || fp="$dir/$filename"
    }
    x_="$fp"
}

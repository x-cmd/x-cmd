# shellcheck shell=dash disable=2016

___x_cmd_codex_skill(){
    [ "$#" -gt 0 ] ||   set -- ll

    local op="$1";      shift
    case "$op" in
        ll|ls|use|unuse|setup)
                        ___x_cmd_codex_skill_"$op"   "$@" ;;
        -h|--help)      ___x_cmd help -m codex skill "$@" ;       return 0 ;;
        *)              N=codex M="skill not such [subcmd=$op]" log:ret:64 ;;
    esac
}

___x_cmd_codex_skill_ll(){
    [ "$#" -gt 0 ] || {
        if ___x_cmd_runmode_allow_manual; then
            set - --fzapp
        else
            set - --tsv
        fi
    }

    local op="$1"; shift
    case "$op" in
        -h|--help)      ___x_cmd help -m codex skill ll;    return 0 ;;
        --fzapp)        ___x_cmd_codex_skill_ll___fzapp         "$@" ;;
        *)              ___x_cmd skill ll "$@" ;;
    esac
}

___x_cmd_codex_skill_ll___fzapp(){
    local x_=""; ___x_cmd skill ll --fzapp_ "$@" || return $?

    local id=
    ___x_cmd ui select id "Next:"                   \
        "x codex skill use $x_"                    \
        "Show detailed information --> $x_"         \
        "EXIT"     || return $?

    case "$id" in
        1)  ___x_cmd codex skill use "$x_"         ;;
        2)  ___x_cmd skill ll --fzpreview "$x_"     ;;
        *)  return 0;;
    esac
}

___x_cmd_codex_skill_ls(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill ls' help:arg:parse
    ___x_cmd skill ls --agent codex
}

___x_cmd_codex_skill_unuse(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill unuse' help:arg:parse
    ___x_cmd skill unuse --agent codex "$@"
}

___x_cmd_codex_skill_use(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill use' help:arg:parse
    ___x_cmd skill use --agent codex "$@"
}


___x_cmd_codex_skill_setup(){
    local X_help_cmd; X_help_cmd='___x_cmd help -m codex skill setup' help:arg:parse

    local x_=""; ___x_cmd_codex_skill_setup___get_agentfile_ || return $?
    local fp="$x_"
    ___x_cmd skill prompt setup codex "$fp"  || return $?
}

___x_cmd_codex_skill_setup___get_agentfile_(){
    local dir="${CODEX_HOME:-$HOME}/.codex"
    local fp="$dir/AGENTS.override.md"
    [ -f "$fp" ] || fp="$dir/AGENTS.md"
    [ -f "$fp" ] || [ ! -f "$dir/config.toml" ] ||{
        local filename; filename="$(
        < "$dir/config.toml" ___x_cmd_cmds awk '
(match($0, "^project_doc_fallback_filenames[ \t]+=[ \t]+\\[[ \t]*\"")){
    l = substr($0, RSTART+RLENGTH)
    print substr(l, 1, index(l, "\"")-1)
}
'
        )"
        [ -z "$filename" ] || fp="$dir/$filename"
    }
    x_="$fp"
}

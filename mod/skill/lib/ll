# shellcheck shell=dash

___x_cmd_skill_ll(){
    [ "$#" -gt 0 ] || {
        if ___x_cmd_runmode_allow_manual; then
            set - --app
        else
            set - --tsv
        fi
    }

    local op="$1"; shift
    case "$op" in
        -h|--help)      ___x_cmd help -m skill ll;    return 0 ;;
        --app)          ___x_cmd_skill_ll___app           "$@" ;;
        --app_)         ___x_cmd_skill_ll___app_          "$@" ;;

        --fzapp)        ___x_cmd_skill_ll___fzapp         "$@" ;;
        --fzapp_)       ___x_cmd_skill_ll___fzapp_        "$@" ;;
        --fzdata)       ___x_cmd_skill_ll___fz_data       "$@" ;;
        --fzpreview)    ___x_cmd_skill_ll___fz_preview    "$@" ;;

        --csv)          ___x_cmd_skill_ll___csv           "$@" ;;
        --tsv)          ___x_cmd_skill_ll___tsv           "$@" ;;
        --id)           ___x_cmd_skill_ll___id            "$@" ;;
        *)              ___x_cmd_skill_ll___app "$op"     "$@" ;;
    esac
}

___x_cmd_skill_ll___raw(){
    ___x_cmd_skill___data_check || return $?
    ___x_cmd_cmds cat "$___X_CMD_SKILL_FULL_INDEX_FILE"
}

___x_cmd_skill_ll___id(){
    ___x_cmd_skill___data_check || return $?
    {
        local header; read -r header

        local IFS="$___X_CMD_UNSEENCHAR_HT"
        local x_id=""; local x_other
        while read -r x_id x_other; do
            printf "%s\n" "$x_id"
        done
    }  < "$___X_CMD_SKILL_FULL_INDEX_FILE"
}

___x_cmd_skill_ll___tsv(){
    ___x_cmd_skill_ll___raw
}

___x_cmd_skill_ll___csv(){
    ___x_cmd_skill_ll___raw | ___x_cmd tsv tocsv
}

___x_cmd_skill_ll___app_(){
    x_=""
    ___x_cmd_runmode_allow_manual || N=skill M="Not supported in non-interactive mode" log:ret:64

    ___x_cmd_skill___data_check || return $?
    skill:info "Ctrl-D to exit. Ctrl-C to interrupt."
    local ___X_CMD_CSV_APP_DATA_CURROW=""
    ___x_cmd csv app --clear --return line --preview 'name,author,url,reference,license,description' \
        -- ___x_cmd skill ll --csv || return $?

    x_="${___X_CMD_CSV_APP_DATA_CURROW%%,*}"
    [ -n "$x_" ] || return 1
}

___x_cmd_skill_ll___app(){
    local x_=""; ___x_cmd_skill_ll___app_ "$@" || return $?

    # local id=
    # ___x_cmd ui select id "Next:"                       \
    #     "Access the comprehensive details pertaining to the skill"       \
    #     "The integration of a skill into claude-code/codex."             \
    #     "EXIT"     || return $?

    # case "$id" in
    #     1)      ;;
    #     *)      return 0;;
    # esac
}

___x_cmd_skill_ll___fzapp_(){
    x_=""
    ___x_cmd_runmode_allow_manual || N=skill M="Not supported in non-interactive mode" log:ret:64

    ___x_cmd_skill___data_check || return $?
    x_="$( ___X_CMD_RUNMODE="$___X_CMD_RUNMODE" ___x_cmdexe skill ll --fzdata )" || return $?

    [ -n "$x_" ] || return 1
}

___x_cmd_skill_ll___fz_data(){
    ___x_cmd_skill_ll___raw \
        | ___x_cmd awk -F'\t' -f "$___X_CMD_ROOT_MOD/skill/lib/awk/fz_data.awk" \
        | ___x_cmd_skill___fzf  \
            --preview='___x_cmdexe skill ll --fzpreview {1}'  \
            --preview-window=right:70%:wrap                   \
            --accept-nth=1
}

___x_cmd_skill_ll___fz_preview(){
    local id="${1}"
    ___x_cmd_skill_ll___raw | ___x_cmd awk -F'\t' -v id="$id" -f "$___X_CMD_ROOT_MOD/skill/lib/awk/fz_preview.awk"
}

___x_cmd_skill_ll___fzapp(){
    local x_=""; ___x_cmd_skill_ll___fzapp_ "$@" || return $?
    ___x_cmd_skill_ll___fz_preview "$x_"
}

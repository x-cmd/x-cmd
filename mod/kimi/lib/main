# shellcheck shell=dash

___X_CMD_KIMI_DEFAULT_ENDPOINT="https://api.kimi.com/coding/"
___X_CMD_KIMI_DEFAULT_FIRST_MODEL='kimi-for-coding'

___x_cmd log init kimi

xrc:mod:lib     kimi   __runcmd  __install  cfg

___x_cmd_kimi___main(){
    [ "$#" -gt 0 ] ||   set -- --runmain

    local op="$1";      shift
    case "$op" in
        -h|--help)      ___x_cmd help -m kimi   "$@" ;   return 0 ;;

        cfg|--cfg)      ___x_cmd_kimi_cfg       "$@" ;;
        --cur)          ___x_cmd_kimi_cur       "$@" ;;
        init|--init)    ___x_cmd_kimi_init      "$@" ;;

        offload|mapf)
                        ___x_cmd_kimi_"$op"     "$@" ;;
        --install)      ___x_cmd_kimi___install      ;;
        --upgrade)      ___x_cmd_kimi___upgrade      ;;
        --uninstall)    ___x_cmd_kimi___uninstall    ;;

        --|--runmain)   ___x_cmd_kimi___runmain       "$@" ;;
        --runcmd)       ___x_cmd_kimi___runcmd        "$@" ;;
        *)              ___x_cmd_kimi___runmain "$op" "$@" ;;
    esac
}

___x_cmd_kimi_offload(){

    local from=""
    local to=""
    local prompt=""

    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)      ___x_cmd help -m kimi offload "$@" ; return 0 ;;
            --from)         from="$2" ;     arg:2:shift ;;
            --to)           to="$2" ;       arg:2:shift ;;
            -p|--prompt)    prompt="$2";    arg:2:shift ;;
            *)              break ;;
        esac
    done

    local topic="$1"
    [ -n "$topic" ]     ||  N=kimi M="Please provide the topic of content to offload." log:ret:1

    local final_prompt="Extract content related to the topic '${topic}'.
Ensure accuracy: verify all extracted content is correct and relevant. No fabrication.
"

    if [ -z "$from" ]; then
        final_prompt="${final_prompt}
Try to search the topic of the files used for AI. Like CLAUDE.md, AGENTS.md, or other markdown files that used by AI.
"
    else
        final_prompt="${final_prompt}
The contents to offload of this topic currently in the file -> $from
This is one of the two files you can ONLY change. The other file is the contents you will finally offload to.
"
    fi

    if [ -n "$to" ]; then
        final_prompt="${final_prompt}
Please put all these contents into this file -> $to "
    fi

    [ -z "$prompt" ] || final_prompt="
Please follow the prompt:

$prompt

$final_prompt
"

    ___x_cmd kimi --print -p "$final_prompt"

}

___x_cmd_kimi_apply(){
    :
    # apply agent file ...

}

___x_cmd_kimi_mapf(){
    local rulefilelist=""

    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help)      ___x_cmd help -m kimi mapf "$@" ; return 0 ;;
            -r|--rule)      rulefilelist="${rulefilelist}- ${2}${___X_CMD_UNSEENCHAR_NEWLINE}" ; arg:2:shift ;;
            -p|--prompt)    prompt="$2"; arg:2:shift ;;
            --)             shift; break ;;
            *)              break ;;
        esac
    done

    local fplist=""

    while [ $# -gt 0 ]; do
        case "$1" in
            --)     ___x_cmd_kimi_mapf___handle
                    fplist=""; shift ;;
            *)      fplist="${fplist}- ${1}${___X_CMD_UNSEENCHAR_NEWLINE}" ; shift ;;
        esac
    done

    ___x_cmd_kimi_mapf___handle
}

___x_cmd_kimi_mapf___handle(){
    [ -n "$fplist" ] || continue

    local final_prompt="
Please follow the rules specified in:
$rulefilelist

Process the following files:
$fplist
"

    [ -z "$prompt" ] || final_prompt="
Please follow the prompt:

$final_prompt
"

    ___x_cmd kimi --print -p "$final_prompt"
}
